<html>

<head>
  <script src="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.js"></script>
  <link
      rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/dygraph/2.1.0/dygraph.min.css"
    />
  <title>Home</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.min.js" integrity="sha384-lpyLfhYuitXl2zRZ5Bn2fqnhNAKOAaM/0Kr9laMspuaMiZfGmfwRNFh8HlMy49eQ" crossorigin="anonymous"></script>
</head>

<body>
  <div style="min-height: 100%;">
  <nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-lg">
      <a class="navbar-brand" href="#">DEMO-MI2</a>
      
      <div class="d-flex">
        <ul class="navbar-nav">
          <li class="nav-item">
            <div style="margin-right: 10px;">
              <span class="navbar-text" id="location">
                Unknown
              </span>
            </div>
            
          </li>
          <li class="nav-item">
            <div style="margin-right: 10px;">
              <span class="navbar-text" id="liveDate">
                No-Data
              </span>
            </div>
          </li>
          <li class="nav-item">
            <div style="margin-right: 5px;">
              <span class="navbar-text" id="live-status-text">
                Offline
              </span>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="black" class="bi bi-circle-fill" viewBox="0 0 16 16" id="liveStatus">
                <circle cx="8" cy="8" r="8"/>
              </svg>
            </div>
          </li>
        </ul>
    
      </div>
    </div>
  </nav>
  

  <div class="container-lg">
    
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-lg-2 row-cols-xl-2">


      <div class="col my-4">
        <div class="card">
          <div class="card-body">
            <a class="btn d-block" data-bs-toggle="collapse" href="#collapsetemp" role="button" aria-expanded="false" aria-controls="collapsetemp">
              <h5 class="card-title">Température de l'air</h5>
              <p class="card-text">
                Intérieur: <span id="tempint">Offline</span><span id="tempintunit" style="visibility: hidden;">°C</span></br>
                Extérieur: <span id="tempext">Offline</span><span id="tempextunit" style="visibility: hidden;">°C</span>
              </p>
            </a>
            <div class="collapse" id="collapsetemp">
              <div class="mt-5" id="graphtemp" style="width: auto;"></div>
              <div class="container-fluid">
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Intérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(17, 146, 34);stroke-width:3" /></svg>
                  </div>
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Extérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(29, 31, 168);stroke-width:3" /></svg>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Date: </span><span id="datetemp">Unknown</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col my-4">
        <div class="card">
          <div class="card-body">
            <a class="btn d-block" data-bs-toggle="collapse" href="#collapseglob" role="button" aria-expanded="false" aria-controls="collapseglob">
              <h5 class="card-title">Température Globe</h5>
              <p class="card-text">
                Intérieur: <span id="globint">Offline</span><span id="globintunit" style="visibility: hidden;">°C</span></br>
                Extérieur: <span id="globext">Offline</span><span id="globextunit" style="visibility: hidden;">°C</span>
              </p>
            </a>
            <div class="collapse" id="collapseglob">
              <div class="mt-5" id="graphglob" style="width: auto;"></div>
              <div class="container-fluid">
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Intérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(17, 146, 34);stroke-width:3" /></svg>
                  </div>
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Extérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(29, 31, 168);stroke-width:3" /></svg>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Date: </span><span id="dateglob">Unknown</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col my-4">
        <div class="card">
          <div class="card-body">
            <a class="btn d-block" data-bs-toggle="collapse" href="#collapsewind" role="button" aria-expanded="false" aria-controls="collapsewind">
              <h5 class="card-title">Vitesse de l'air</h5>
              <p class="card-text">
                Intérieur: <span id="windint">Offline</span><span id="windintunit" style="visibility: hidden;">m/s</span></br>
                Extérieur: <span id="windext">Offline</span><span id="windextunit" style="visibility: hidden;">m/s</span>
              </p>
            </a>
            <div class="collapse" id="collapsewind">
              <div class="mt-5" id="graphwind" style="width: auto;"></div>
              <div class="container-fluid">
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Intérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(17, 146, 34);stroke-width:3" /></svg>
                  </div>
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Extérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(29, 31, 168);stroke-width:3" /></svg>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Date: </span><span id="datewind">Unknown</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col my-4">
        <div class="card">
          <div class="card-body">
            <a class="btn d-block" data-bs-toggle="collapse" href="#collapsehumi" role="button" aria-expanded="false" aria-controls="collapsehumi">
              <h5 class="card-title">Humidité relative de l'air</h5>
              <p class="card-text">
                Intérieur: <span id="humiint">Offline</span><span id="humiintunit" style="visibility: hidden;">%</span></br>
                Extérieur: <span id="humiext">Offline</span><span id="humiextunit" style="visibility: hidden;">%</span>
              </p>
            </a>
            <div class="collapse" id="collapsehumi">
              <div class="mt-5" id="graphhumi" style="width: auto;"></div>
              <div class="container-fluid">
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Intérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(17, 146, 34);stroke-width:3" /></svg>
                  </div>
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Extérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(29, 31, 168);stroke-width:3" /></svg>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Date: </span><span id="datehumi">Unknown</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col my-4">
        <div class="card">
          <div class="card-body">
            <a class="btn d-block" data-bs-toggle="collapse" href="#collapsesuni" role="button" aria-expanded="false" aria-controls="collapsesuni">
              <h5 class="card-title">Rayonnement solaire horizontal</h5>
              <p class="card-text">
                Extérieur: <span id="suniext">Offline</span><span id="suniextunit" style="visibility: hidden;">W/m²</span> 
              </p>
            </a>
            <div class="collapse" id="collapsesuni">
              <div class="mt-5" id="graphsuni" style="width: auto;"></div>
              <div class="container-fluid">
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Extérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(17, 146, 114);stroke-width:3" /></svg>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Date: </span><span id="datesuni">Unknown</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col my-4">
        <div class="card">
          <div class="card-body">
            <a class="btn d-block" data-bs-toggle="collapse" href="#collapsepolu" role="button" aria-expanded="false" aria-controls="collapsepolu">
              <h5 class="card-title">Pollution</h5>
              <p class="card-text">
                Extérieur: <span id="poluext">Offline</span><span id="poluextunit" style="visibility: hidden;">μg/m³</span> 
              </p>
            </a>
            <div class="collapse" id="collapsepolu">
              <div class="mt-5" id="graphpolu" style="width: auto;"></div>
              <div class="container-fluid">
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Extérieur</span><svg height="10" width="110"><line x1="10" y1="5" x2="110" y2="5" style="stroke:rgb(17, 146, 114);stroke-width:3" /></svg>
                  </div>
                </div>
                <div class="row justify-content-center">
                  <div class="col-6 text-center" style="min-width: 200px;">
                    <span>Date: </span><span id="datepolu">Unknown</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div style="height: 50px; width: 100%;"></div>
</div>
  <footer class="footer py-3 bg-light" style="clear: both; position: relative; height: 50px;  margin-top: -50px;">
    <div class="container text-center" style="margin: auto;">
      <span class="text-muted">More Details on <a href="http://friloranetdev.tic.heia-fr.ch:8080/map" class="link-secondary">FriIotNet</a></span>
      <span class="text-muted" style="padding-right: 10px; padding-left: 10px;">-</span>
      <span class="text-muted">Return on <a href="https://www.smartlivinglab.ch/fr/modularpavilion/" class="link-secondary">Smartlivinglab</a></span>
      <span class="text-muted" style="padding-right: 10px; padding-left: 10px;">-</span>
      <span class="text-muted">Developed by Julien Piguet & Denis Rosset from <a href="https://www.heia-fr.ch/" class="link-secondary">HEIA-FR</a></span>
    </div>
  </footer>
</body>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    getLiveStatus();
    
    getData("graphtemp", "temp", true, "Température (°C)");
    getData("graphhumi", "humi", true, "Humidité (%)");
    getData("graphglob", "glob", true, "Température (°C)");
    getData("graphwind", "wind", true, "Vitesse du Vent (m/s)");
    getData("graphsuni", "suni", false, "Rayonnement Solaire (W/m²)");
    getData("graphpolu", "polu", false, "Particules fines PM2.5 (μg/m³)");

    const interval = setInterval(function() {
      getLiveStatus();
    
      getData("graphtemp", "temp", true, "Température (°C)");
      getData("graphhumi", "humi", true, "Humidité (%)");
      getData("graphglob", "glob", true, "Température (°C)");
      getData("graphwind", "wind", true, "Vitesse du Vent (m/s)");
      getData("graphsuni", "suni", false, "Rayonnement Solaire (W/m²)");
      getData("graphpolu", "polu", false, "Particules fines PM2.5 (μg/m³)");
    }, 30000);

  });

  function getLiveStatus() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        data = JSON.parse(this.responseText);
        updateField(data);
      }
    };

    function updateField(data) {
      if (data.islive){
        document.getElementById("liveStatus").setAttribute("fill", "green")
        document.getElementById("live-status-text").innerHTML = "On Live"
        
      } else {
        document.getElementById("liveStatus").setAttribute("fill", "red")
        document.getElementById("live-status-text").innerHTML = "Offline"
      }
      document.getElementById("location").innerHTML = data.location
      document.getElementById("liveDate").innerHTML = data.date_last_measure;
    };
    xhttp.open("GET", "../is-live", true);
    xhttp.send();
  }

  function getData(elementId, name, pos, yaxisname) {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        data = JSON.parse(this.responseText);
        plotChart(data);
      }
    };

    function plotChart(data) {
      var old = document.getElementById("collapse"+name).className
      document.getElementById("collapse"+name).className = "collapse show";
      g = new Dygraph(document.getElementById(elementId), data.data, {
        width: 500,
        height: 400,
        connectSeparatedPoints : true,
        ylabel: yaxisname
      });
      if (pos) {
        document.getElementById(""+name+"int").innerHTML = data.lastint;
        if (data.lastint != "Offline"){
          document.getElementById(""+name+"intunit").style.visibility = "visible";
        } else {
          document.getElementById(""+name+"intunit").style.visibility = "hidden";
        }
        document.getElementById(""+name+"ext").innerHTML = data.lastext;
        if (data.lastext != "Offline"){
          document.getElementById(""+name+"extunit").style.visibility = "visible";
        } else {
          document.getElementById(""+name+"extunit").style.visibility = "hidden";
        }
      } else {
        document.getElementById(""+name+"ext").innerHTML = data.last;
        if (data.last != "Offline"){
          document.getElementById(""+name+"extunit").style.visibility = "visible";
        } else {
          document.getElementById(""+name+"extunit").style.visibility = "hidden";
        }
      }
      document.getElementById("date"+name).innerHTML = data.date;
      document.getElementById("collapse"+name).className = old;
    };
    xhttp.open("GET", "../get-data?type="+name, true);
    xhttp.send();
  }


</script>

</html>